<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Floral Haven - Professional Management</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter font from Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #FCE7F3; /* Light pink background */
        }
        .page-content {
            display: none;
        }
        .active-page {
            display: flex;
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center">

    <!-- Main Container -->
    <div class="w-full max-w-4xl bg-white rounded-2xl shadow-xl overflow-hidden md:flex md:flex-row">

        <!-- Sidebar / Navigation -->
        <aside class="w-full md:w-1/3 p-8 flex flex-col items-center justify-center bg-pink-500 text-white text-center md:rounded-l-2xl">
            <h1 class="text-3xl font-bold mb-2">Floral Haven</h1>
            <p class="text-pink-100 mb-6">Your professional floral solution.</p>
            <nav class="w-full space-y-4">
                <button id="nav-login" class="nav-button w-full py-3 rounded-lg bg-pink-400 hover:bg-pink-300 transition-colors duration-300 shadow-md">Login</button>
                <button id="nav-order" class="nav-button w-full py-3 rounded-lg bg-pink-400 hover:bg-pink-300 transition-colors duration-300 shadow-md">Create Order</button>
                <button id="nav-customer-details" class="nav-button w-full py-3 rounded-lg bg-pink-400 hover:bg-pink-300 transition-colors duration-300 shadow-md">Customer Details</button>
                <button id="nav-order-summary" class="nav-button w-full py-3 rounded-lg bg-pink-400 hover:bg-pink-300 transition-colors duration-300 shadow-md">Order Summary</button>
            </nav>
            <div class="mt-8">
                <img src="https://placehold.co/300x300/F472B6/ffffff?text=Professional+Floral" alt="Professional Floral Image" class="w-32 h-32 rounded-full object-cover border-4 border-pink-200 shadow-lg">
            </div>
        </aside>

        <!-- Page Content Area -->
        <main class="w-full md:w-2/3 p-8 flex flex-col justify-center">

            <!-- 1. Login Page -->
            <section id="login-page" class="page-content active-page flex-col">
                <h2 class="text-3xl font-semibold mb-6 text-pink-600">Login</h2>
                <form id="login-form" class="space-y-4">
                    <div>
                        <label for="username" class="block text-sm font-medium text-gray-700">Username</label>
                        <input type="text" id="username" name="username" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-pink-500 focus:ring-pink-500 p-2 border">
                    </div>
                    <div>
                        <label for="password" class="block text-sm font-medium text-gray-700">Password</label>
                        <input type="password" id="password" name="password" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-pink-500 focus:ring-pink-500 p-2 border">
                    </div>
                    <button type="submit" class="w-full py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-pink-600 hover:bg-pink-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-pink-500 transition-colors duration-300">Login</button>
                    <p id="login-message" class="text-sm text-center text-red-500 mt-4"></p>
                </form>
            </section>

            <!-- 2. Order Page -->
            <section id="order-page" class="page-content flex-col">
                <h2 class="text-3xl font-semibold mb-6 text-pink-600">Create New Order</h2>
                <form id="order-form" class="space-y-4">
                    <div>
                        <label for="product-select" class="block text-sm font-medium text-gray-700">Flower Name</label>
                        <select id="product-select" name="product" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-pink-500 focus:ring-pink-500 p-2 border">
                            <!-- Options will be populated by JavaScript -->
                        </select>
                    </div>
                    <div>
                        <label for="quantity" class="block text-sm font-medium text-gray-700">Quantity</label>
                        <input type="number" id="quantity" name="quantity" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-pink-500 focus:ring-pink-500 p-2 border">
                    </div>
                    <button type="submit" class="w-full py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-pink-600 hover:bg-pink-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-pink-500 transition-colors duration-300">Add Order</button>
                </form>
            </section>

            <!-- 3. Customer Details Page -->
            <section id="customer-details-page" class="page-content flex-col">
                <h2 class="text-3xl font-semibold mb-6 text-pink-600">Customer Details</h2>
                <form id="customer-form" class="space-y-4">
                    <div>
                        <label for="customer-name" class="block text-sm font-medium text-gray-700">Name</label>
                        <input type="text" id="customer-name" name="customer-name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-pink-500 focus:ring-pink-500 p-2 border">
                    </div>
                    <div>
                        <label for="customer-phone" class="block text-sm font-medium text-gray-700">Phone Number</label>
                        <input type="tel" id="customer-phone" name="customer-phone" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-pink-500 focus:ring-pink-500 p-2 border">
                    </div>
                    <div>
                        <label for="customer-email" class="block text-sm font-medium text-gray-700">Email</label>
                        <input type="email" id="customer-email" name="customer-email" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-pink-500 focus:ring-pink-500 p-2 border">
                    </div>
                    <div>
                        <label for="customer-address" class="block text-sm font-medium text-gray-700">Address</label>
                        <textarea id="customer-address" name="customer-address" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-pink-500 focus:ring-pink-500 p-2 border"></textarea>
                    </div>
                    <button type="submit" class="w-full py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-pink-600 hover:bg-pink-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-pink-500 transition-colors duration-300">Save Customer Details</button>
                </form>
            </section>

            <!-- 4. Order Summary Page -->
            <section id="order-summary-page" class="page-content flex-col">
                <h2 class="text-3xl font-semibold mb-6 text-pink-600">Order Summary</h2>
                <div id="summary-content" class="space-y-6">
                    <div class="p-4 bg-pink-50 rounded-lg shadow">
                        <h3 class="font-semibold text-lg text-pink-700 mb-2">Customer Information</h3>
                        <p><strong>Name:</strong> <span id="summary-name">N/A</span></p>
                        <p><strong>Phone:</strong> <span id="summary-phone">N/A</span></p>
                        <p><strong>Email:</strong> <span id="summary-email">N/A</span></p>
                        <p><strong>Address:</strong> <span id="summary-address">N/A</span></p>
                    </div>
                    <div class="p-4 bg-pink-50 rounded-lg shadow">
                        <h3 class="font-semibold text-lg text-pink-700 mb-2">Order Information</h3>
                        <p><strong>Product:</strong> <span id="summary-product">N/A</span></p>
                        <p><strong>Quantity:</strong> <span id="summary-quantity">N/A</span></p>
                        <p><strong>Unit Price:</strong> <span id="summary-unit-price">N/A</span></p>
                        <p><strong>Total Amount:</strong> <span id="summary-total-amount">N/A</span></p>
                        <p><strong>Delivery Date:</strong> <span id="summary-delivery-date">N/A</span></p>
                    </div>
                </div>
                <button id="final-submit-btn" class="mt-6 w-full py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-pink-600 hover:bg-pink-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-pink-500 transition-colors duration-300">Finalize Order</button>
            </section>
        </main>
    </div>

    <!-- Custom Modal for Alerts -->
    <div id="custom-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center p-4">
        <div class="bg-white rounded-lg p-6 shadow-xl w-full max-w-sm text-center">
            <p id="modal-message" class="text-lg text-gray-800 mb-4"></p>
            <button id="modal-close-btn" class="w-full py-2 px-4 rounded-md text-white bg-pink-600 hover:bg-pink-700 transition-colors duration-300">OK</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- State Management ---
            let appState = {
                currentPage: 'login-page',
                user: null,
                products: [],
                selectedProduct: null,
                customer: {
                    name: '',
                    phone: '',
                    email: '',
                    address: ''
                },
                order: {
                    flowerId: null,
                    quantity: '',
                    deliveryDate: ''
                }
            };

            // --- DOM Elements ---
            const pages = document.querySelectorAll('.page-content');
            const navButtons = document.querySelectorAll('.nav-button');
            const loginForm = document.getElementById('login-form');
            const loginMessage = document.getElementById('login-message');
            const orderForm = document.getElementById('order-form');
            const productSelect = document.getElementById('product-select');
            const customerForm = document.getElementById('customer-form');
            const finalSubmitBtn = document.getElementById('final-submit-btn');

            const modal = document.getElementById('custom-modal');
            const modalMessage = document.getElementById('modal-message');
            const modalCloseBtn = document.getElementById('modal-close-btn');

            // --- Page Navigation Function ---
            const showPage = (pageId) => {
                pages.forEach(page => {
                    page.classList.remove('active-page');
                    page.style.display = 'none';
                });
                const activePage = document.getElementById(pageId);
                if (activePage) {
                    activePage.classList.add('active-page');
                    activePage.style.display = 'flex';
                }
            };

            // --- Custom Modal Function ---
            const showModal = (message) => {
                modalMessage.textContent = message;
                modal.style.display = 'flex';
            };

            modalCloseBtn.addEventListener('click', () => {
                modal.style.display = 'none';
            });

            // --- Fetch Products from Backend ---
            const fetchProducts = async () => {
                console.log('Attempting to fetch products from backend...');
                try {
                    const response = await fetch('/api/products');
                    const result = await response.json();
                    console.log('Server response for products:', result);
                    if (response.ok && result.success) {
                        appState.products = result.products;
                        populateProductSelect();
                    } else {
                        throw new Error(result.message || 'Failed to fetch products from the server.');
                    }
                } catch (error) {
                    console.error('Failed to fetch products:', error);
                    showModal('Failed to load products. Please ensure the Node.js server is running and the database is configured correctly.');
                }
            };

            const populateProductSelect = () => {
                productSelect.innerHTML = '';
                appState.products.forEach(product => {
                    const option = document.createElement('option');
                    option.value = product.flower_id;
                    option.textContent = `${product.flower_name} ($${product.price.toFixed(2)})`;
                    productSelect.appendChild(option);
                });
                if (appState.products.length > 0) {
                    const selectedId = productSelect.value;
                    appState.selectedProduct = appState.products.find(p => p.flower_id == selectedId);
                }
            };

            // --- Event Listeners for Navigation ---
            navButtons.forEach(button => {
                button.addEventListener('click', (e) => {
                    const pageId = e.target.id.replace('nav-', '') + '-page';
                    if (appState.user || pageId === 'login-page') {
                        showPage(pageId);
                        appState.currentPage = pageId;
                        updateFormsAndSummary();
                    } else {
                        showModal("Please log in first.");
                        showPage('login-page');
                    }
                });
            });

            // Handle product selection change
            productSelect.addEventListener('change', (e) => {
                const selectedId = e.target.value;
                appState.selectedProduct = appState.products.find(p => p.flower_id == selectedId);
                updateFormsAndSummary();
            });

            // --- Form Handlers ---
            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const username = e.target.username.value;
                const password = e.target.password.value;
                console.log('Attempting to log in...');

                try {
                    const response = await fetch('/api/login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username, password })
                    });
                    const result = await response.json();

                    if (result.success) {
                        appState.user = { username: username };
                        loginMessage.textContent = '';
                        showModal("Login successful! Welcome.");
                        showPage('order-page');
                    } else {
                        loginMessage.textContent = result.message;
                    }
                } catch (error) {
                    console.error('Login error:', error);
                    loginMessage.textContent = 'Could not connect to the server. Please ensure the Node.js server is running.';
                }
            });

            orderForm.addEventListener('submit', (e) => {
                e.preventDefault();
                appState.order.flowerId = productSelect.value;
                appState.order.quantity = e.target.quantity.value;
                appState.order.deliveryDate = (new Date()).toISOString().split('T')[0];
                
                showModal("Order details saved. Please fill out customer details next.");
                showPage('customer-details-page');
                updateFormsAndSummary();
            });

            customerForm.addEventListener('submit', (e) => {
                e.preventDefault();
                appState.customer.name = e.target['customer-name'].value;
                appState.customer.phone = e.target['customer-phone'].value;
                appState.customer.email = e.target['customer-email'].value;
                appState.customer.address = e.target['customer-address'].value;
                showModal("Customer details saved. Review the order summary.");
                showPage('order-summary-page');
                updateFormsAndSummary();
            });

            finalSubmitBtn.addEventListener('click', async () => {
                try {
                    const response = await fetch('/api/save-order', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            customer: appState.customer,
                            order: appState.order
                        })
                    });
                    const result = await response.json();

                    if (result.success) {
                        showModal(result.message);
                        resetForms();
                        appState.user = null;
                        showPage('login-page');
                    } else {
                        showModal(result.message);
                    }
                } catch (error) {
                    console.error('Finalize order error:', error);
                    showModal('Failed to finalize order. Please check the server.');
                }
            });

            // --- Update UI with State Data ---
            const updateFormsAndSummary = () => {
                document.getElementById('customer-name').value = appState.customer.name;
                document.getElementById('customer-phone').value = appState.customer.phone;
                document.getElementById('customer-email').value = appState.customer.email;
                document.getElementById('customer-address').value = appState.customer.address;

                document.getElementById('quantity').value = appState.order.quantity;
                
                document.getElementById('summary-name').textContent = appState.customer.name || 'N/A';
                document.getElementById('summary-phone').textContent = appState.customer.phone || 'N/A';
                document.getElementById('summary-email').textContent = appState.customer.email || 'N/A';
                document.getElementById('summary-address').textContent = appState.customer.address || 'N/A';

                const summaryProduct = appState.products.find(p => p.flower_id == appState.order.flowerId);
                const unitPrice = summaryProduct ? summaryProduct.price : 0;
                const totalAmount = unitPrice * appState.order.quantity;

                document.getElementById('summary-product').textContent = summaryProduct ? summaryProduct.flower_name : 'N/A';
                document.getElementById('summary-quantity').textContent = appState.order.quantity || 'N/A';
                document.getElementById('summary-unit-price').textContent = summaryProduct ? `$${unitPrice.toFixed(2)}` : 'N/A';
                document.getElementById('summary-total-amount').textContent = `$${totalAmount.toFixed(2)}`;
                document.getElementById('summary-delivery-date').textContent = appState.order.deliveryDate || 'N/A';
            };

            // --- Reset Forms on Final Submission ---
            const resetForms = () => {
                orderForm.reset();
                customerForm.reset();
                appState.customer = { name: '', phone: '', email: '', address: '' };
                appState.order = { flowerId: null, quantity: '', deliveryDate: '' };
                appState.selectedProduct = null;
            };

            // Initial page load and data fetch
            showPage('login-page');
            fetchProducts();
        });
    </script>

</body>
</html>
